{{ if eq .chezmoi.os "darwin" }}
#!/bin/sh
# Run once on macOS: install Homebrew if missing, then apply Brewfile.
# Idempotent and robust against missing tools.

set -eu

log()  { printf "\033[1;32m[brew-bundle]\033[0m %s\n" "$*"; }
warn() { printf "\033[1;33m[warn]\033[0m %s\n" "$*"; }

# Ensure this script only runs on macOS hosts when rendered accidentally elsewhere.
if [ "$(uname -s)" != "Darwin" ]; then
  log "Skipping: brew bootstrap only runs on macOS."
  exit 0
fi

# If BREWFILE is exported by you, use it; otherwise default to the repo Brewfile.
# The template is rendered by chezmoi at apply-time.
: "${BREWFILE:={{ quote .chezmoi.sourceDir }}/Brewfile}"

# 1) Ensure Homebrew is installed
if ! command -v brew >/dev/null 2>&1; then
  log "Installing Homebrew"
  NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# 2) Ensure brew is on PATH for this shell (Apple Silicon default)
if [ -d /opt/homebrew/bin ]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# 3) Apply your Brewfile (if present)
if [ -f "$BREWFILE" ]; then
  log "Running 'brew bundle' with $BREWFILE"
  brew update || true
  if ! brew bundle --file="$BREWFILE"; then
  brew bundle --file="$BREWFILE" || warn "brew bundle finished with non-fatal errors."
  fi
else
  warn "No Brewfile found at $BREWFILE (skipping)."
fi

log "Done."
{{ end }}
