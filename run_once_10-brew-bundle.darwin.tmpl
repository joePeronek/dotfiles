#!/bin/sh
# Run once on macOS: install Homebrew (Apple Silicon only) and apply Brewfile.
# ChezMoi will only run this on macOS hosts because of the `.darwin` suffix.

set -Eeuo pipefail

log()  { printf "\033[1;32m[brew-bundle]\033[0m %s\n" "$*"; }
warn() { printf "\033[1;33m[warn]\033[0m %s\n" "$*"; }
die()  { printf "\033[1;31m[error]\033[0m %s\n" "$*\n"; exit 1; }

# Extra safety check
if [ "$(uname -s)" != "Darwin" ]; then
  log "Skipping: not macOS."
  exit 0
fi

# Default Brewfile path (chezmoi source directory)
: "${BREWFILE:={{ quote .chezmoi.sourceDir }}/Brewfile}"

# 1) Ensure Homebrew is installed
if ! command -v brew >/dev/null 2>&1; then
  log "Homebrew not found — installing (non-interactive)"
  NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" || \
    die "Homebrew installer failed"
fi

# 2) Ensure brew is available from /opt/homebrew (Apple Silicon)
BREW=/opt/homebrew/bin/brew
if [ ! -x "$BREW" ]; then
  die "Expected brew at /opt/homebrew/bin/brew but not found"
fi

# Export brew environment into this shell
# shellcheck disable=SC2046
eval "$($BREW shellenv)"

log "Using brew at: $BREW"

# 3) Apply Brewfile if it exists
if [ -f "$BREWFILE" ]; then
  log "Applying Brewfile: $BREWFILE"
  "$BREW" update || warn "brew update failed (continuing)"
  HOMEBREW_NO_AUTO_UPDATE=1 "$BREW" bundle --file="$BREWFILE" || \
    warn "brew bundle reported issues (non-fatal)"
else
  warn "No Brewfile at $BREWFILE — skipping"
fi

log "Done."
