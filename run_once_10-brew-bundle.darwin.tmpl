#!/bin/sh
# Run once on macOS: install Homebrew if missing, then apply Brewfile.

set -eu

log() { printf "\033[1;32m[brew-bundle]\033[0m %s\n" "$*"; }
warn() { printf "\033[1;33m[warn]\033[0m %s\n" "$*"; }

BREWFILE="{{ .chezmoi.sourceDir }}/Brewfile"

# 1) Ensure Homebrew is installed
if ! command -v brew >/dev/null 2>&1; then
  log "Installing Homebrew…"
  NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" || {
    warn "Homebrew install failed"; exit 1;
  }
fi

# 2) Ensure brew is on PATH for this shell
if [ -d /opt/homebrew/bin ]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
elif [ -d /usr/local/bin ]; then
  eval "$(/usr/local/bin/brew shellenv)"
fi

# 3) Apply your Brewfile
if [ -f "$BREWFILE" ]; then
  log "Running 'brew bundle' with $BREWFILE…"
  brew update || true
  brew bundle --file="$BREWFILE" || warn "brew bundle finished with non-fatal errors."
else
  warn "No Brewfile found at $BREWFILE (skipping)."
fi

log "Done."

