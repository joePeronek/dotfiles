#!/bin/sh
# Bootstrap essential packages on Linux hosts using apt or dnf.

set -eu

log()  { printf '[packages] %s\n' "$*"; }
warn() { printf '[warn] %s\n' "$*" >&2; }

SUDO=""
if [ "$(id -u)" -ne 0 ]; then
  if command -v sudo >/dev/null 2>&1; then
    SUDO="sudo"
  else
    warn "sudo not available and not running as root; skipping package install."
    exit 0
  fi
fi

if command -v apt-get >/dev/null 2>&1; then
  MANAGER="apt"
elif command -v dnf >/dev/null 2>&1; then
  MANAGER="dnf"
else
  warn "No supported package manager detected (apt or dnf)."
  exit 0
fi

log "Detected $MANAGER; ensuring baseline tooling is present."

case "$MANAGER" in
  apt)
    PACKAGES=$(cat <<'EOF'
build-essential
curl
git
ripgrep
fzf
tmux
neovim
python3
python3-venv
python3-pip
golang-go
cmake
pkg-config
meson
autoconf
automake
libtool
wget
unzip
htop
chezmoi
zsh
zsh-autosuggestions
zsh-theme-powerlevel10k
fonts-jetbrains-mono
EOF
    )

    $SUDO apt-get update

    for pkg in $PACKAGES; do
      if dpkg -s "$pkg" >/dev/null 2>&1; then
        continue
      fi
      if ! $SUDO apt-get install -y "$pkg"; then
        warn "Failed to install $pkg (continuing)."
      fi
    done
    ;;
  dnf)
    PACKAGES=$(cat <<'EOF'
gcc
gcc-c++
make
curl
git
ripgrep
fzf
tmux
neovim
python3
python3-pip
python3-virtualenv
golang
cmake
meson
autoconf
automake
libtool
pkgconf-pkg-config
wget
unzip
htop
chezmoi
zsh
zsh-autosuggestions
powerlevel10k
jetbrains-mono-fonts
EOF
    )

    $SUDO dnf -y makecache

    for pkg in $PACKAGES; do
      if rpm -q "$pkg" >/dev/null 2>&1; then
        continue
      fi
      if ! $SUDO dnf -y install "$pkg"; then
        warn "Failed to install $pkg (continuing)."
      fi
    done
    ;;
esac

log "Package bootstrap finished."
